---
layout: canvas-post
title: graphic 1
date: 2019-4-6 18:57:10
categories: programming
---

<style>

#input-ta {
	width: 100%;
	height: 200px;
}
</style>

<input type="button" value="play" id="play-bt">
<input type="button" value="copy" id="copy-bt">
<input type="button" value="reset" id="reset-bt">

<textarea id="input-ta"></textarea>

<script type="text/javascript">

const SAMPLE_PERIOD = 20;
const MAX_GAP = 1000;

/* init */
const c = canvas.getContext('2d');
const w = canvas.width;
const h = canvas.height;

c.strokeStyle = 'solid';

// canvas helper function
function makeLine(p1, p2, style) {
	c.strokeStyle = style;
	c.beginPath();
	c.moveTo(p1.x, p1.y);
	c.lineTo(p2.x, p2.y);
	c.stroke();
}

function getCursorPosition(canvas, evt) {
	var x, y;

	x = evt.clientX
		+ document.body.scrollLeft
		+ document.documentElement.scrollLeft
		- canvas.offsetLeft;

	y = evt.clientY
		+ document.body.scrollTop
		+ document.documentElement.scrollTop
		- canvas.offsetTop;

	return {x:x, y:y};
}

function Scribble() {
	this.start = Date.now();
	this.points = [];
	this.shouldAdd = true;

	this.block = () => this.shouldAdd = false;
	this.unblock = () => this.shouldAdd = true;

	this.addPoint = (p) => {
		if (!this.shouldAdd && p) {
			return;
		};

		console.log('adding:', p);

		this.shouldAdd = false;
		this.points.push({
			p: p,
			t: Date.now(),
		});
		setTimeout(() => {this.shouldAdd = true;}, SAMPLE_PERIOD);
	};

	this.toJson = () => {
		let ret = [];
		for (let i = 0; i < this.points.length - 1; i++) {
			let d = Math.min(
				this.points[i+1].t - this.points[i].t,
				MAX_GAP);

			ret.push({
				p: this.points[i].p,
				d: d,
			});
		}
		ret.push({
			p: this.points[this.points.length - 1].p,
			d: 0,
		});

		return JSON.stringify(ret);
	};

	this.fromJson = (s) => {
		this.points = JSON.parse(s);
	};

	this.reset = () => {
		this.points = [];
		this.shouldAdd = true;
	}

}

Scribble.play = function(s, c, cb) {
	let points = JSON.parse(s);

	let i = 0;
	let move = () => {
		if (i >= points.length) {
			cb();
			return;
		}

		let point = points[i];
		i += 1;
		if (point.p) {
			c.lineTo(point.p.x, point.p.y);
			c.stroke();
		} else if (points[i]) {
			console.log(points[i-1]);
			point = points[i];
			c.moveTo(point.p.x, point.p.y);
		}

		console.log(point);
		console.log("waiting ", point.d);
		setTimeout(move, point.d);
	}
	c.clearRect(0, 0, w, h);
	console.log("cleared");
	p = points[0].p;
	c.beginPath(p.x, p.y);
	move();
};

const scribble = new Scribble();

const lst = (evt) => {
	console.log(evt);
	p = getCursorPosition(canvas, evt);
	scribble.addPoint(p);
	c.lineTo(p.x, p.y);
	c.stroke();
};

canvas.addEventListener('mousedown', (evt) => {
	console.log(getCursorPosition(canvas, evt));

	c.beginPath(evt.layerX, evt.layerY);
	lst(evt);
	canvas.addEventListener('mousemove', lst);
});

canvas.addEventListener('mouseup', (evt) => {
	canvas.removeEventListener('mousemove', lst);
	scribble.addPoint(null);
	let text = scribble.toJson();
	document.querySelector("#input-ta")
		.value = text;
});


document.querySelector('#copy-bt')
	.addEventListener('click', (_) => {
		let text = scribble.toJson();
		console.log(text.length);
		document.querySelector('#input-ta')
			.select();
		document.execCommand('copy');
		alert('copied to clipboard');
	});

document.querySelector('#reset-bt')
	.addEventListener('click', (_) => {
		scribble.reset();
		c.clearRect(0, 0, w, h);
		document.querySelector('#input-ta')
			.value = '';
	});

document.querySelector('#play-bt')
	.addEventListener('click', (_) => {
		scribble.block();
		let s = document.querySelector('#input-ta').value;
		console.log(s);
		Scribble.play(s, c, scribble.unblock);
	});

const emma = `[{"p":{"x":28,"y":70},"d":58},
{"p":{"x":28,"y":70},"d":31},
{"p":{"x":30,"y":70},"d":32},
{"p":{"x":35,"y":70},"d":35},
{"p":{"x":42,"y":69},"d":31},
{"p":{"x":57,"y":69},"d":34},
{"p":{"x":68,"y":69},"d":33},
{"p":{"x":86,"y":68},"d":33},
{"p":{"x":92,"y":69},"d":34},
{"p":{"x":102,"y":69},"d":33},
{"p":{"x":112,"y":69},"d":32},
{"p":{"x":115,"y":69},"d":35},
{"p":{"x":120,"y":69},"d":50},
{"p":{"x":124,"y":69},"d":33},
{"p":{"x":129,"y":68},"d":33},
{"p":{"x":134,"y":67},"d":34},
{"p":{"x":138,"y":67},"d":52},
{"p":{"x":140,"y":66},"d":32},
{"p":{"x":145,"y":66},"d":33},
{"p":{"x":147,"y":65},"d":50},
{"p":{"x":148,"y":65},"d":120},
{"p":null,"d":610},
{"p":{"x":92,"y":77},"d":37},
{"p":{"x":91,"y":80},"d":50},
{"p":{"x":89,"y":90},"d":34},
{"p":{"x":87,"y":105},"d":33},
{"p":{"x":85,"y":120},"d":32},
{"p":{"x":85,"y":132},"d":34},
{"p":{"x":85,"y":142},"d":33},
{"p":{"x":85,"y":154},"d":33},
{"p":{"x":84,"y":163},"d":34},
{"p":{"x":84,"y":169},"d":50},
{"p":{"x":84,"y":173},"d":33},
{"p":{"x":84,"y":176},"d":34},
{"p":{"x":84,"y":178},"d":33},
{"p":{"x":84,"y":179},"d":32},
{"p":{"x":84,"y":184},"d":34},
{"p":{"x":83,"y":189},"d":50},
{"p":{"x":83,"y":191},"d":34},
{"p":{"x":83,"y":194},"d":34},
{"p":{"x":83,"y":196},"d":33},
{"p":{"x":83,"y":197},"d":34},
{"p":{"x":83,"y":199},"d":33},
{"p":{"x":83,"y":202},"d":34},
{"p":{"x":83,"y":202},"d":30},
{"p":{"x":83,"y":202},"d":35},
{"p":{"x":83,"y":204},"d":41},
{"p":null,"d":287},
{"p":{"x":48,"y":216},"d":55},
{"p":{"x":49,"y":215},"d":33},
{"p":{"x":58,"y":213},"d":34},
{"p":{"x":77,"y":209},"d":33},
{"p":{"x":99,"y":207},"d":36},
{"p":{"x":117,"y":206},"d":31},
{"p":{"x":131,"y":205},"d":35},
{"p":{"x":134,"y":205},"d":49},
{"p":{"x":137,"y":204},"d":33},
{"p":{"x":138,"y":204},"d":155},
{"p":null,"d":600},
{"p":{"x":274,"y":116},"d":46},
{"p":{"x":274,"y":115},"d":32},
{"p":{"x":277,"y":110},"d":33},
{"p":{"x":282,"y":105},"d":34},
{"p":{"x":288,"y":100},"d":35},
{"p":{"x":296,"y":94},"d":32},
{"p":{"x":302,"y":92},"d":132},
{"p":{"x":327,"y":98},"d":34},
{"p":{"x":329,"y":100},"d":51},
{"p":{"x":331,"y":104},"d":34},
{"p":{"x":331,"y":108},"d":31},
{"p":{"x":331,"y":114},"d":35},
{"p":{"x":330,"y":121},"d":51},
{"p":{"x":329,"y":131},"d":31},
{"p":{"x":327,"y":137},"d":52},
{"p":{"x":324,"y":146},"d":32},
{"p":{"x":321,"y":150},"d":33},
{"p":{"x":319,"y":153},"d":34},
{"p":{"x":315,"y":156},"d":31},
{"p":{"x":311,"y":160},"d":35},
{"p":{"x":307,"y":164},"d":34},
{"p":{"x":302,"y":169},"d":34},
{"p":{"x":296,"y":174},"d":33},
{"p":{"x":290,"y":180},"d":50},
{"p":{"x":281,"y":193},"d":33},
{"p":{"x":278,"y":202},"d":32},
{"p":{"x":277,"y":213},"d":34},
{"p":{"x":277,"y":223},"d":50},
{"p":{"x":279,"y":230},"d":34},
{"p":{"x":282,"y":236},"d":50},
{"p":{"x":282,"y":236},"d":66},
{"p":{"x":283,"y":236},"d":34},
{"p":null,"d":677},
{"p":{"x":284,"y":126},"d":40},
{"p":{"x":284,"y":125},"d":49},
{"p":{"x":280,"y":118},"d":34},
{"p":{"x":277,"y":114},"d":51},
{"p":{"x":272,"y":108},"d":33},
{"p":{"x":270,"y":105},"d":32},
{"p":{"x":266,"y":103},"d":32},
{"p":{"x":264,"y":102},"d":35},
{"p":{"x":263,"y":102},"d":34},
{"p":{"x":260,"y":103},"d":33},
{"p":{"x":256,"y":105},"d":34},
{"p":{"x":251,"y":108},"d":32},
{"p":{"x":246,"y":113},"d":54},
{"p":{"x":242,"y":119},"d":30},
{"p":{"x":238,"y":126},"d":32},
{"p":{"x":236,"y":132},"d":35},
{"p":{"x":234,"y":141},"d":33},
{"p":{"x":233,"y":146},"d":49},
{"p":{"x":233,"y":153},"d":35},
{"p":{"x":236,"y":161},"d":48},
{"p":{"x":246,"y":174},"d":35},
{"p":{"x":251,"y":179},"d":50},
{"p":{"x":261,"y":185},"d":33},
{"p":{"x":269,"y":190},"d":49},
{"p":{"x":275,"y":194},"d":33},
{"p":{"x":278,"y":197},"d":34},
{"p":{"x":281,"y":201},"d":32},
{"p":{"x":282,"y":203},"d":50},
{"p":{"x":283,"y":206},"d":52},
{"p":{"x":283,"y":206},"d":50},
{"p":{"x":283,"y":206},"d":83},
{"p":{"x":284,"y":206},"d":3},
{"p":null,"d":890},
{"p":{"x":427,"y":111},"d":41},
{"p":{"x":427,"y":112},"d":50},
{"p":{"x":427,"y":123},"d":31},
{"p":{"x":427,"y":134},"d":35},
{"p":{"x":428,"y":152},"d":33},
{"p":{"x":434,"y":174},"d":34},
{"p":{"x":438,"y":186},"d":32},
{"p":{"x":443,"y":197},"d":34},
{"p":{"x":448,"y":202},"d":33},
{"p":{"x":452,"y":206},"d":33},
{"p":{"x":459,"y":211},"d":50},
{"p":{"x":472,"y":217},"d":35},
{"p":{"x":476,"y":218},"d":50},
{"p":{"x":481,"y":217},"d":33},
{"p":{"x":491,"y":213},"d":82},
{"p":{"x":506,"y":199},"d":33},
{"p":{"x":510,"y":193},"d":86},
{"p":{"x":514,"y":174},"d":32},
{"p":{"x":514,"y":163},"d":32},
{"p":{"x":514,"y":156},"d":34},
{"p":{"x":514,"y":146},"d":34},
{"p":{"x":514,"y":137},"d":66},
{"p":{"x":514,"y":125},"d":33},
{"p":{"x":514,"y":123},"d":68},
{"p":{"x":514,"y":121},"d":65},
{"p":{"x":514,"y":121},"d":50},
{"p":{"x":514,"y":120},"d":29},
{"p":null,"d":0}]`

if (window.location.href.endsWith('emma')) {
	document.querySelector('#input-ta')
		.value = emma;
	document.querySelector('#play-bt')
		.click();
}

</script>
